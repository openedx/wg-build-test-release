<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.21.2 -->
<document source="/Users/sarinacanelake/openedx/edx-platform/docs/references/docs/openedx/features/discounts/docs/decisions/0001-determining-discount-location.rst" translation_progress="{'total': 0, 'translated': 0}" xmlns:c="https://www.sphinx-doc.org/" xmlns:changeset="https://www.sphinx-doc.org/" xmlns:citation="https://www.sphinx-doc.org/" xmlns:cpp="https://www.sphinx-doc.org/" xmlns:http="https://www.sphinx-doc.org/" xmlns:index="https://www.sphinx-doc.org/" xmlns:js="https://www.sphinx-doc.org/" xmlns:math="https://www.sphinx-doc.org/" xmlns:py="https://www.sphinx-doc.org/" xmlns:rst="https://www.sphinx-doc.org/" xmlns:std="https://www.sphinx-doc.org/">
    <section ids="course-user-discounts" names="course\ +\ user\ discounts">
        <title>Course + User Discounts</title>
        <section ids="status" names="status">
            <title>Status</title>
            <paragraph>Accepted</paragraph>
        </section>
        <section ids="context" names="context">
            <title>Context</title>
            <paragraph>We are implementing platform-wide discounts that are determined using a combination of course and user. The
                data used in this determination lives in the LMS. The discount will be messaged in the LMS, and then autoapplied
                on the basket page of Ecommerce. See the table below for information on how this new discount differs from our
                current discounting schemes.</paragraph>
            <table>
                <tgroup cols="3">
                    <colspec colwidth="37"></colspec>
                    <colspec colwidth="37"></colspec>
                    <colspec colwidth="36"></colspec>
                    <thead>
                        <row>
                            <entry>
                                <paragraph>Discounts</paragraph>
                            </entry>
                            <entry>
                                <paragraph>Coupons</paragraph>
                            </entry>
                            <entry>
                                <paragraph>Enterprise Offers</paragraph>
                            </entry>
                        </row>
                    </thead>
                    <tbody>
                        <row>
                            <entry>
                                <paragraph>Permanent</paragraph>
                            </entry>
                            <entry>
                                <paragraph>Temporary</paragraph>
                            </entry>
                            <entry>
                                <paragraph>Permanent</paragraph>
                            </entry>
                        </row>
                        <row>
                            <entry>
                                <paragraph>Applies to all – certain combos of
                                    of user and course exempted</paragraph>
                            </entry>
                            <entry>
                                <paragraph>Applies to a specific subset of
                                    users and/or courses</paragraph>
                            </entry>
                            <entry>
                                <paragraph>Applies to enterprise users</paragraph>
                            </entry>
                        </row>
                        <row>
                            <entry>
                                <paragraph>Messaged in specific places in the
                                    LMS</paragraph>
                            </entry>
                            <entry>
                                <paragraph>Sometimes messaged on the marketing
                                    site (specific promotions)</paragraph>
                            </entry>
                            <entry>
                                <paragraph>Messaged in integration</paragraph>
                            </entry>
                        </row>
                        <row>
                            <entry>
                                <paragraph>Currently calculated in the LMS</paragraph>
                            </entry>
                            <entry>
                                <paragraph>Calculated in Ecommerce</paragraph>
                            </entry>
                            <entry>
                                <paragraph>Calculated in Ecommerce</paragraph>
                            </entry>
                        </row>
                    </tbody>
                </tgroup>
            </table>
        </section>
        <section ids="decisions" names="decisions">
            <title>Decisions</title>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph><strong>The location of the calculation of discount applicability/eligibility</strong></paragraph>
                    <enumerated_list enumtype="loweralpha" prefix="" suffix=".">
                        <list_item>
                            <paragraph>We want <emphasis>one</emphasis> service to contain the logic for whether a discount can be applied/can be communicated to the
                                user. This way, upkeep is much simpler: if/when the logic changes, it only needs to change in one place.
                                Additionally, if we duplicated the logic, we would either need to duplicate the data, ask for the data, or
                                have slightly different logic (which would present cases in which the outcome is different depending on the
                                service). We are unhappy with all of those implementations.</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>We will calculate applicability/eligibility in the LMS. All of the data that we need currently resides in
                                the LMS. In order to get the information to make the determination in Ecommerce, we would need to ask LMS
                                for the data. If the ultimate destination of that data was the LMS (to decide whether to message the
                                discount), we would have excess communication and more failure points. See below for a diagram of what we
                                don’t want:</paragraph>
                        </list_item>
                    </enumerated_list>
                </list_item>
            </enumerated_list>
            <literal_block force="False" language="default" linenos="False" xml:space="preserve">LMS -asks for discount applicability------------------&gt; Ecommerce
LMS &lt;-----------asks for data to dermine applicability- Ecommerce
LMS -sends back data----------------------------------&gt; Ecommerce
LMS &lt;-------------------------sends back applicability- Ecommerce</literal_block>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph><strong>Communication of discount applicability</strong></paragraph>
                    <enumerated_list enumtype="loweralpha" prefix="" suffix=".">
                        <list_item>
                            <paragraph>Within the LMS, when we need to get the applicability of a discount for a user and course, we can just
                                import the function and call it.</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>Outside of the LMS, we need a way to get this information in a validated fashion. We have added a rest
                                endpoint for that communication. Because we want to be able to use the information both on the front-end
                                and back-end without risk of the user creating their own discounts, we are sending it as a jwt, which is
                                signed. See C for more information on how specifically it will be used on the Ecommerce front-end.</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>We do not want to make a synchronous call from the Ecommerce backend to the LMS every time the basket
                                page is loaded. See this decision record link for more information:
                                <reference refuri="https://github.com/openedx/Ecommerce/blob/master/docs/decisions/0002-no-synchronous-calls.rst">https://github.com/openedx/Ecommerce/blob/master/docs/decisions/0002-no-synchronous-calls.rst</reference>  However,
                                we are happy to make an ajax call from the front-end.
                                The basket page needs this information for two reasons: 1) So that the correct price is shown to the user,
                                and the user is informed that they are recieving a discount. 2) So that the correct price is charged to
                                the user during payment.  We will handle both by making the ajax call, updating the ui on the page, and
                                also updating the data that is sent to the server during the payment step. Because we are using a JWT, we
                                can verify that the discount is correct. Right now, another team is working on adding a MFE to Ecommerce.
                                Rather than have to implement the front-end code in Ecommerce to do this twice, we will write the code
                                to make the ajax call, and if there is a discount, reload the page passing the JWT as a parameter. See
                                diagram below for current (interum) state of the communication of the discount:</paragraph>
                        </list_item>
                    </enumerated_list>
                </list_item>
            </enumerated_list>
            <literal_block force="False" language="default" linenos="False" xml:space="preserve">LMS &lt;--asks about discount applicability- Ecom Frontend                                      Ecom Backend
LMS -sends applicability as JWT---------&gt; Ecom Frontend
-----IF APPLICABLE----
LMS                                       Ecom Frontend -Reloads the page w/ JWT as param--&gt; Ecom Backend</literal_block>
        </section>
    </section>
</document>
