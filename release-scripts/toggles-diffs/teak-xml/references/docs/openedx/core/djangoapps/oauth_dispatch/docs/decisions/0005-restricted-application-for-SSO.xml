<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.21.2 -->
<document source="/Users/sarinacanelake/openedx/edx-platform/docs/references/docs/openedx/core/djangoapps/oauth_dispatch/docs/decisions/0005-restricted-application-for-SSO.rst" translation_progress="{'total': 0, 'translated': 0}" xmlns:c="https://www.sphinx-doc.org/" xmlns:changeset="https://www.sphinx-doc.org/" xmlns:citation="https://www.sphinx-doc.org/" xmlns:cpp="https://www.sphinx-doc.org/" xmlns:http="https://www.sphinx-doc.org/" xmlns:index="https://www.sphinx-doc.org/" xmlns:js="https://www.sphinx-doc.org/" xmlns:math="https://www.sphinx-doc.org/" xmlns:py="https://www.sphinx-doc.org/" xmlns:rst="https://www.sphinx-doc.org/" xmlns:std="https://www.sphinx-doc.org/">
    <section ids="restricted-application-for-sso" names="5.\ restricted\ application\ for\ sso">
        <title>5. Restricted Application for SSO</title>
    </section>
    <section ids="status" names="status">
        <title>Status</title>
        <paragraph>Partially Replaced (see ADR <reference name="Enforce Scopes in LMS APIs" refuri="https://github.com/openedx/edx-platform/blob/master/openedx/core/djangoapps/oauth_dispatch/docs/decisions/0006-enforce-scopes-in-LMS-APIs.rst#3-restricted-applications-receive-unexpired-jwts-signed-with-a-new-key">Enforce Scopes in LMS APIs</reference>)</paragraph>
        <target ids="enforce-scopes-in-lms-apis" names="enforce\ scopes\ in\ lms\ apis" refuri="https://github.com/openedx/edx-platform/blob/master/openedx/core/djangoapps/oauth_dispatch/docs/decisions/0006-enforce-scopes-in-LMS-APIs.rst#3-restricted-applications-receive-unexpired-jwts-signed-with-a-new-key"></target>
    </section>
    <section ids="context" names="context">
        <title>Context</title>
        <paragraph>External edX clients would like to use edX as an Identity Provider and verify
            the edX identity of a user. The OAuth2 protocol’s Authorization Code grant type
            already supports this behavior and our OAuth2 clients can use it for this
            purpose. However, we want to issue <emphasis>scoped</emphasis> access tokens to external edX
            clients so end users can limit what API calls the clients make on their behalf.</paragraph>
        <paragraph>The OAuth2 standard for controlling the use of access tokens is <reference name="Access Token Scopes" refuri="https://tools.ietf.org/html/rfc6749#section-3.3">Access Token
                Scopes</reference>. With Scopes, an end user explicitly authorizes the actions that an
            OAuth2 client is allowed to perform with the issued access token. Scopes
            allow us to support SSO and issue access tokens on behalf of users, knowing
            the users have approved the usage of the tokens.</paragraph>
        <paragraph>However, the edX platform has not enabled wider usage of Scopes by API
            endpoints, beyond the basic values of ‘email’ and ‘profile’. It would be a
            major undertaking to update all of our microservices to fully support Scopes,
            while keeping the system up and running.</paragraph>
        <target ids="access-token-scopes" names="access\ token\ scopes" refuri="https://tools.ietf.org/html/rfc6749#section-3.3"></target>
    </section>
    <section ids="decision" names="decision">
        <title>Decision</title>
        <paragraph>Implement a new model in oauth_dispatch to selectively designate DOT Applications
            as “Restricted Applications”. For those external clients that want SSO capability
            with edX as an Identity Provider, configure them as a “Restricted Application”.
            Although these applications can still request access tokens via the usual
            Authorization Code grant protocol, issue them only <strong>expired</strong> access tokens
            so they cannot make unauthorized calls to our API endpoints.</paragraph>
        <note>
            <paragraph>Although we still use the new model for “Restricted Applications”, the decision to use <strong>expired</strong> access tokens has been superseded by ADR <reference name="Enforce Scopes in LMS APIs" refuri="https://github.com/openedx/edx-platform/blob/master/openedx/core/djangoapps/oauth_dispatch/docs/decisions/0006-enforce-scopes-in-LMS-APIs.rst#3-restricted-applications-receive-unexpired-jwts-signed-with-a-new-key">Enforce Scopes in LMS APIs</reference>. That ADR specifies a different method to restrict “Restricted Applications” from accessing API endpoints that have not implemented Scopes.</paragraph>
        </note>
    </section>
    <section ids="consequences" names="consequences">
        <title>Consequences</title>
        <section ids="pluses" names="pluses">
            <title>Pluses</title>
            <bullet_list bullet="*">
                <list_item>
                    <paragraph>It is a minimal effort to introduce a new “Restricted Application” model
                        and update the oauth_dispatch logic to create expired tokens.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>SSO OAuth2 clients can now verify the identity of edX users when they
                        successfully receive an OAuth2 access token in the Authorization Code grant
                        type handshake.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>If they make the access token request with token_type=jwt, they receive
                        a JSON Web Token (JWT) with basic information about the user’s identity,
                        including their username and edX Anonymous ID.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>If they include ‘email’ scope in their authorization request and the user
                        approves, the JWT will include the user’s email address as well.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>If they include ‘profile’ scope in their authorization request and the user
                        approves, the JWT will include the user’s full name and whether they have
                        staff access.</paragraph>
                </list_item>
            </bullet_list>
        </section>
        <section ids="minuses" names="minuses">
            <title>Minuses</title>
            <bullet_list bullet="*">
                <list_item>
                    <paragraph>Returning expired tokens adds additional technical debt on top of the
                        debt incurred by not implementing scopes.</paragraph>
                </list_item>
            </bullet_list>
        </section>
    </section>
</document>
