<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.21.2 -->
<document source="/Users/sarinacanelake/openedx/edx-platform/docs/references/docs/openedx/core/djangoapps/oauth_dispatch/docs/decisions/0015-add-scope-user-id-for-jwt-password-grant.rst" translation_progress="{'total': 0, 'translated': 0}" xmlns:c="https://www.sphinx-doc.org/" xmlns:changeset="https://www.sphinx-doc.org/" xmlns:citation="https://www.sphinx-doc.org/" xmlns:cpp="https://www.sphinx-doc.org/" xmlns:http="https://www.sphinx-doc.org/" xmlns:index="https://www.sphinx-doc.org/" xmlns:js="https://www.sphinx-doc.org/" xmlns:math="https://www.sphinx-doc.org/" xmlns:py="https://www.sphinx-doc.org/" xmlns:rst="https://www.sphinx-doc.org/" xmlns:std="https://www.sphinx-doc.org/">
    <section ids="add-scope-user-id-for-jwt-token-for-grant-type-password" names="15.\ add\ scope\ user_id\ for\ jwt\ token\ for\ grant_type\ password">
        <title>15. Add scope user_id for JWT token for grant_type password</title>
        <section ids="status" names="status">
            <title>Status</title>
            <paragraph>Accepted</paragraph>
        </section>
        <section ids="context" names="context">
            <title>Context</title>
            <paragraph>In Feb 2018, to enable analytics (Segment) from Microfrontends (MFEs), a <literal>user_id</literal> claim was added to the JWT token <problematic ids="id2" refid="id1">`in this PR&lt;https://github.com/openedx/edx-platform/pull/19765&gt;`__</problematic>.</paragraph>
            <paragraph>The LMS API <reference name="to create authentication tokens" refuri="https://github.com/openedx/edx-platform/blob/caf8e456e28f9b9a1f5fa7186d3d155112fb75be/openedx/core/djangoapps/oauth_dispatch/urls.py#L14">to create authentication tokens</reference> is used by external organizations to request a token on behalf of their users, mostly using grant_type <literal>client_credentials</literal> in the request. Since <literal>user_id</literal> is considered sensitive information, especially when combined with email and username which were already available in the JWT, it was decided to only add the <literal>user_id</literal> claim when a <literal>user_id</literal> scope was supplied. All MFE JWT cookies, which are known to only be used directly by the user, automatically used the <literal>user_id</literal> scope in order to get the required <literal>user_id</literal> claim.</paragraph>
            <paragraph>No ADR could be found for the Feb 2018 decision detailed above.</paragraph>
            <paragraph>In June 2019, an <reference name="ADR was captured in ecommerce" refuri="https://github.com/openedx/ecommerce/blob/master/docs/decisions/0004-unique-identifier-for-users.rst">ADR was captured in ecommerce</reference> around the requirements to have the LMS user_id available for requests to ecommerce.</paragraph>
            <paragraph>In 2022, the mobile apps switched to using JWTs for authentication. However, these JWTs were missing the <literal>user_id</literal> scope and claim required by the ecommerce service.</paragraph>
            <target ids="to-create-authentication-tokens" names="to\ create\ authentication\ tokens" refuri="https://github.com/openedx/edx-platform/blob/caf8e456e28f9b9a1f5fa7186d3d155112fb75be/openedx/core/djangoapps/oauth_dispatch/urls.py#L14"></target>
            <target ids="adr-was-captured-in-ecommerce" names="adr\ was\ captured\ in\ ecommerce" refuri="https://github.com/openedx/ecommerce/blob/master/docs/decisions/0004-unique-identifier-for-users.rst"></target>
        </section>
        <section ids="decisions" names="decisions">
            <title>Decisions</title>
            <bullet_list bullet="-">
                <list_item>
                    <paragraph>The original decision to add the <literal>user_id</literal> claim to the JWT token using the <literal>user_id</literal> scope has been captured in the context of this ADR, because no ADR could be found.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>The scope <literal>user_id</literal> will be added to all requests having grant_type <literal>password</literal> in the API <title_reference>/oauth2/access_token/</title_reference>.</paragraph>
                </list_item>
            </bullet_list>
        </section>
        <section ids="consequences" names="consequences">
            <title>Consequences</title>
            <bullet_list bullet="-">
                <list_item>
                    <paragraph>The claim <literal>user_id</literal> will be present in the JWT token for all requesters who already have access to the login credentials of the user account.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>The <literal>user_id</literal> scope will continue to protect other JWT requests that donâ€™t require this sensitive information.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>This pattern could potentially be used to clean-up the manually added <literal>user_id</literal> scope for oauth clients involved in the social auth flow in the future.</paragraph>
                </list_item>
            </bullet_list>
        </section>
    </section>
</document>
