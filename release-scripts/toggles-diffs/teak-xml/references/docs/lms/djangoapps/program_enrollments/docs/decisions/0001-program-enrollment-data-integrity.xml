<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.21.2 -->
<document source="/Users/sarinacanelake/openedx/edx-platform/docs/references/docs/lms/djangoapps/program_enrollments/docs/decisions/0001-program-enrollment-data-integrity.rst" translation_progress="{'total': 0, 'translated': 0}" xmlns:c="https://www.sphinx-doc.org/" xmlns:changeset="https://www.sphinx-doc.org/" xmlns:citation="https://www.sphinx-doc.org/" xmlns:cpp="https://www.sphinx-doc.org/" xmlns:http="https://www.sphinx-doc.org/" xmlns:index="https://www.sphinx-doc.org/" xmlns:js="https://www.sphinx-doc.org/" xmlns:math="https://www.sphinx-doc.org/" xmlns:py="https://www.sphinx-doc.org/" xmlns:rst="https://www.sphinx-doc.org/" xmlns:std="https://www.sphinx-doc.org/">
    <section ids="programenrollment-model-data-integrity" names="programenrollment\ model\ data\ integrity">
        <title>ProgramEnrollment Model Data Integrity</title>
        <section ids="status" names="status">
            <title>Status</title>
            <paragraph>Accepted (circa August 2019)</paragraph>
        </section>
        <section ids="context" names="context">
            <title>Context</title>
            <paragraph>For the sake of fundamental data integrity, we are introducing 2 unique
                constraints on the <literal>program_enrollments.ProgramEnrollment</literal> model.</paragraph>
        </section>
        <section ids="decisions" names="decisions">
            <title>Decisions</title>
            <paragraph>The unique constraints are on the following column sets:</paragraph>
            <bullet_list bullet="*">
                <list_item>
                    <paragraph><literal>('user', 'program_uuid', 'curriculum_uuid')</literal></paragraph>
                </list_item>
                <list_item>
                    <paragraph><literal>('external_user_key', 'program_uuid', 'curriculum_uuid')</literal></paragraph>
                </list_item>
            </bullet_list>
            <paragraph>Note that either the <literal>user</literal> column or the <literal>external_user_key</literal> column may be null.
                In the future, it would be nice to add a validation step at the Django model layer
                that restricts a model instance from having null values for both of these fields.</paragraph>
        </section>
        <section ids="consequences" names="consequences">
            <title>Consequences</title>
            <paragraph>The first constraint supports the cases in which we save program enrollment records
                that donâ€™t have any association with an external organization, e.g. our MicroMasters programs.
                Non-realized enrollments, where the <literal>user</literal> value is null, are not affected by this constraint.</paragraph>
            <paragraph>As for the second constraint , we want to disallow the ability of anyone to register a learner,
                as identified by <literal>external_user_key</literal>, into the same program and curriculum more than once.
                No enrollment record with a null <literal>external_user_key</literal> is affected by this constraint.</paragraph>
            <paragraph>Together, these constraints restrict the duplication of learner records in a specific
                program/curriculum, where the learner is identified either by their <literal>auth.User.id</literal> or
                some <literal>external_user_key</literal>.</paragraph>
            <paragraph>This constraint set does NOT support the use case of a single <literal>auth.User</literal> being enrolled
                in the same program/curriculum with two or more different <literal>external_user_keys</literal>.  Supporting
                this case leads to problematic situations, e.g. how to decide which of these program enrollment
                records to link to a program-course enrollment?  If needed, we could introduce an additional
                set of models to support this situation.</paragraph>
        </section>
    </section>
</document>
