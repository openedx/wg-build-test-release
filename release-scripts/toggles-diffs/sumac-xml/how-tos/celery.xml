<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.21.2 -->
<document source="/Users/sarinacanelake/static-clones/edx-platform/docs/how-tos/celery.rst" translation_progress="{'total': 0, 'translated': 0}" xmlns:c="https://www.sphinx-doc.org/" xmlns:changeset="https://www.sphinx-doc.org/" xmlns:citation="https://www.sphinx-doc.org/" xmlns:cpp="https://www.sphinx-doc.org/" xmlns:http="https://www.sphinx-doc.org/" xmlns:index="https://www.sphinx-doc.org/" xmlns:js="https://www.sphinx-doc.org/" xmlns:math="https://www.sphinx-doc.org/" xmlns:py="https://www.sphinx-doc.org/" xmlns:rst="https://www.sphinx-doc.org/" xmlns:std="https://www.sphinx-doc.org/">
    <section ids="how-to-write-a-celery-task" names="how\ to\ write\ a\ celery\ task">
        <title refid="id1">How to write a celery task</title>
        <topic classes="contents" ids="contents" names="contents">
            <title>Contents</title>
            <bullet_list>
                <list_item>
                    <paragraph><reference ids="id1" refid="how-to-write-a-celery-task">How to write a celery task</reference></paragraph>
                    <bullet_list>
                        <list_item>
                            <paragraph><reference ids="id2" refid="introduction">Introduction</reference></paragraph>
                        </list_item>
                        <list_item>
                            <paragraph><reference ids="id3" refid="routing-key-argument-in-task-decorator"><literal>routing_key</literal> argument in <literal>@task</literal> decorator</reference></paragraph>
                        </list_item>
                        <list_item>
                            <paragraph><reference ids="id4" refid="dictionaries-for-routing">Dictionaries For Routing</reference></paragraph>
                        </list_item>
                    </bullet_list>
                </list_item>
            </bullet_list>
        </topic>
        <section ids="introduction" names="introduction">
            <title refid="id2">Introduction</title>
            <paragraph>With the celery 4.4 upgrade, routing of celery tasks was broken and all the tasks were routed to the default queues of lms and cms. So we investigated and found that celery changed the implementation style of a custom router. Previously celery needed a class based custom router and in 4.0 they introduced a new Task Router API, in which celery needs a function for routing tasks to desired queues. Hence, we updated the routing architecture of edx-platform.</paragraph>
        </section>
        <section ids="routing-key-argument-in-task-decorator" names="routing_key\ argument\ in\ @task\ decorator">
            <title refid="id3"><literal>routing_key</literal> argument in <literal>@task</literal> decorator</title>
            <paragraph>Another change in celery’s newer version was that now adding <literal>routing_key</literal> as parameter in <literal>@task</literal> decorator stopped routing task to the matching queue with that key. This change was not included in their docs. Hence we opted for newer architecture for routing.</paragraph>
        </section>
        <section ids="dictionaries-for-routing" names="dictionaries\ for\ routing">
            <title refid="id4">Dictionaries For Routing</title>
            <paragraph>We have added dictionaries <literal>EXPLICIT_QUEUES</literal> in django settings for both lms and cms. If you want to route your task in any queue other than the default queue, you have to mention in that dict. For entering a new task in that dictionary you have to follow the pattern given below.
                Now there is no need to mention <literal>routing_key</literal> argument in <literal>@task</literal> decorator</paragraph>
            <literal_block force="False" highlight_args="{}" language="default" linenos="False" xml:space="preserve">'lms.djangoapps.grades.tasks.compute_all_grades_for_course': {
'queue': POLICY_CHANGE_GRADES_ROUTING_KEY},</literal_block>
            <paragraph>Note: If a task has added into <literal>EXPLICIT_QUEUES</literal> dict in LMS then it will be routed only if it is triggered in LMS environment. If you want to trigger it from CMS environment too then you have to add to CMS’s <literal>EXPLICIT_QUEUES</literal> too.</paragraph>
        </section>
    </section>
</document>
