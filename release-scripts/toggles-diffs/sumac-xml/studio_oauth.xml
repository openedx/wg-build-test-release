<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.21.2 -->
<document source="/Users/sarinacanelake/static-clones/edx-platform/docs/studio_oauth.rst" translation_progress="{'total': 0, 'translated': 0}" xmlns:c="https://www.sphinx-doc.org/" xmlns:changeset="https://www.sphinx-doc.org/" xmlns:citation="https://www.sphinx-doc.org/" xmlns:cpp="https://www.sphinx-doc.org/" xmlns:http="https://www.sphinx-doc.org/" xmlns:index="https://www.sphinx-doc.org/" xmlns:js="https://www.sphinx-doc.org/" xmlns:math="https://www.sphinx-doc.org/" xmlns:py="https://www.sphinx-doc.org/" xmlns:rst="https://www.sphinx-doc.org/" xmlns:std="https://www.sphinx-doc.org/">
    <section ids="enabling-oauth-for-studio-login" names="enabling\ oauth\ for\ studio\ login">
        <title>Enabling OAuth for Studio login</title>
        <paragraph>This is a migration guide for converting Studio login to use OAuth, for use in the Lilac to Maple upgrade.</paragraph>
        <section ids="background" names="background">
            <title>Background</title>
            <paragraph>As of Lilac, the Studio by default shares a session cookie with the LMS.  This either forces Studio to be on a subdomain of the LMS or the LMS to set its session cookie on a wide domain, which exposes it to a potentially large number of subdomains.</paragraph>
            <paragraph>Maple’s configuration assumes that Studio will use LMS’s OAuth2-based single-sign-on (SSO). This means that the cookies (and domains) can be decoupled to improve both flexibility and security. However, there are a few steps to take to finish this configuration (otherwise Studio logins will not work.)</paragraph>
        </section>
        <section ids="migration" names="migration">
            <title>Migration</title>
            <paragraph>Studio and LMS need to be configured in each environment to enable the new flow, with the exception of devstack and sandboxes (which will autoconfigure for OAuth.) Migration involves enabling OAuth and separating the session cookies for LMS and Studio. The session cookie split will require Studio users to log in again.</paragraph>
            <paragraph>Follow these steps for each deployed environment (stage, production, etc.):</paragraph>
            <enumerated_list enumtype="arabic" prefix="" suffix=".">
                <list_item>
                    <paragraph>Create a <literal>studio_worker</literal> service account in the LMS:</paragraph>
                    <literal_block force="False" language="default" linenos="False" xml:space="preserve">./manage.py lms manage_user studio_worker some-email@your-domain --unusable-password</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Register an SSO OAuth2 client in LMS:</paragraph>
                    <literal_block force="False" language="default" linenos="False" xml:space="preserve">./manage.py lms create_dot_application --grant-type authorization-code --skip-authorization --redirect-uris "https://studio.YOURSITE/complete/edx-oauth2/" --scopes "user_id" studio-sso studio_worker</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Configure LMS to log out Studio when logging out by adding <literal>&lt;public Studio root&gt;/logout/</literal> to the LMS <literal>IDA_LOGOUT_URI_LIST</literal>.</paragraph>
                </list_item>
                <list_item>
                    <paragraph>Find your new client in your LMS Django admin (<literal>/admin/oauth2_provider/application/?q=studio-sso</literal>) and then configure Studio to allow completion of OAuth flow:</paragraph>
                    <literal_block force="False" language="default" linenos="False" xml:space="preserve">SOCIAL_AUTH_EDX_OAUTH2_KEY: &lt;client id&gt;
SOCIAL_AUTH_EDX_OAUTH2_SECRET: &lt;client secret&gt;
SOCIAL_AUTH_EDX_OAUTH2_URL_ROOT: &lt;server-to-server LMS root URL&gt;  # possibly same as public LMS root URL
SOCIAL_AUTH_EDX_OAUTH2_PUBLIC_URL_ROOT: &lt;public LMS root URL&gt;</literal_block>
                </list_item>
                <list_item>
                    <paragraph>Configure Studio to initiate OAuth flow and use a separate session cookie:</paragraph>
                    <literal_block force="False" language="default" linenos="False" xml:space="preserve">SESSION_COOKIE_NAME: studio_sessionid</literal_block>
                </list_item>
            </enumerated_list>
            <paragraph>This cookie renaming step is also a good opportunity to change <literal>SESSION_COOKIE_DOMAIN</literal> if desired, since it allows for a clean transition without having to worry about <reference name="flaky behavior driven by order-unstable cookie-sending" refuri="https://fwielstra.github.io/2017/03/13/fun-with-cookies-and-subdomains/">flaky behavior driven by order-unstable cookie-sending</reference><target ids="flaky-behavior-driven-by-order-unstable-cookie-sending" names="flaky\ behavior\ driven\ by\ order-unstable\ cookie-sending" refuri="https://fwielstra.github.io/2017/03/13/fun-with-cookies-and-subdomains/"></target>. Narrowing the domain (or removing it, to keep subdomains from seeing the cookie) may improve the security of your deployment, but the best option depends on the exact layout of your domain names and is beyond the scope of this document.</paragraph>
        </section>
    </section>
</document>
