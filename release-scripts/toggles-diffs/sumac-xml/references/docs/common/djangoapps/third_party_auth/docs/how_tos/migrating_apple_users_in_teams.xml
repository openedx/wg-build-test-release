<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.21.2 -->
<document source="/Users/sarinacanelake/static-clones/edx-platform/docs/references/docs/common/djangoapps/third_party_auth/docs/how_tos/migrating_apple_users_in_teams.rst" translation_progress="{'total': 0, 'translated': 0}" xmlns:c="https://www.sphinx-doc.org/" xmlns:changeset="https://www.sphinx-doc.org/" xmlns:citation="https://www.sphinx-doc.org/" xmlns:cpp="https://www.sphinx-doc.org/" xmlns:http="https://www.sphinx-doc.org/" xmlns:index="https://www.sphinx-doc.org/" xmlns:js="https://www.sphinx-doc.org/" xmlns:math="https://www.sphinx-doc.org/" xmlns:py="https://www.sphinx-doc.org/" xmlns:rst="https://www.sphinx-doc.org/" xmlns:std="https://www.sphinx-doc.org/">
    <section ids="migrating-apple-users-while-switching-teams-on-apple" names="migrating\ apple\ users\ while\ switching\ teams\ on\ apple">
        <title>Migrating Apple users while switching teams on Apple</title>
        <paragraph>This document explains how to migrate apple signed-in users in the event of
            switching teams on the Apple Developer console. When a user uses Apple to sign in,
            LMS receives an <reference name="id_token from apple containing user information" refuri="https://developer.apple.com/documentation/sign_in_with_apple/sign_in_with_apple_rest_api/authenticating_users_with_sign_in_with_apple">id_token from apple containing user information</reference>, including
            user’s unique identifier with key <title_reference>sub</title_reference>. This unique identifier is unique to
            Apple team this user belongs to. Upon switching teams on Apple, developers need
            to migrate users from one team to another i.e. migrate users’ unique
            identifiers. In the LMS, users’ unique apple identifiers are stored in
            social_django.models.UserSocialAuth.uid. Following is an outline specifying the
            migration process.</paragraph>
        <enumerated_list enumtype="arabic" prefix="" suffix=".">
            <list_item>
                <paragraph><reference name="Create transfer_identifiers for all apple users" refuri="https://developer.apple.com/documentation/sign_in_with_apple/transferring_your_apps_and_users_to_another_team">Create transfer_identifiers for all apple users</reference> using the current respective apple unique id.</paragraph>
                <enumerated_list enumtype="lowerroman" prefix="" suffix=".">
                    <list_item>
                        <paragraph>Run management command generate_and_store_apple_transfer_ids to generate and store apple transfer ids.</paragraph>
                    </list_item>
                    <list_item>
                        <paragraph>Transfer ids are stored in third_party_auth.models.AppleMigrationUserIdInfo to be used later on.</paragraph>
                    </list_item>
                </enumerated_list>
            </list_item>
            <list_item>
                <paragraph>Transfer/Migrate teams on Apple account.</paragraph>
                <enumerated_list enumtype="lowerroman" prefix="" suffix=".">
                    <list_item>
                        <paragraph>After the migration, <reference name="Apple continues to send the transfer identifier" refuri="https://developer.apple.com/documentation/sign_in_with_apple/sign_in_with_apple_rest_api/authenticating_users_with_sign_in_with_apple">Apple continues to send the transfer identifier</reference> with key <title_reference>transfer_sub</title_reference> in information sent after login.</paragraph>
                    </list_item>
                    <list_item>
                        <paragraph>These transfer identifiers are available in the login information for 60 days after team transfer.</paragraph>
                    </list_item>
                </enumerated_list>
                <enumerated_list enumtype="lowerroman" prefix="" start="2" suffix=".">
                    <list_item>
                        <paragraph>The method get_user_id() in third_party_auth.appleid.AppleIdAuth enables existing users to sign in by matching the transfer_sub sent in the login information with stored records of old Apple unique identifiers in third_party_auth.models.AppleMigrationUserIdInfo.</paragraph>
                    </list_item>
                </enumerated_list>
            </list_item>
            <list_item>
                <paragraph>Update Apple Backend credentials in third_party_auth.models.OAuth2ProviderConfig for the Apple backend.</paragraph>
            </list_item>
            <list_item>
                <paragraph>Create new team-scoped apple unique ids’ for users after the migration using transfer ids created in Step 1.</paragraph>
                <enumerated_list enumtype="lowerroman" prefix="" suffix=".">
                    <list_item>
                        <paragraph>Run management command generate_and_store_new_apple_ids to generate and store new team-scoped apple ids.</paragraph>
                    </list_item>
                </enumerated_list>
            </list_item>
            <list_item>
                <paragraph>Update apple unique identifiers in the Database with new team-scoped apple ids retrieved in step 3.</paragraph>
                <enumerated_list enumtype="lowerroman" prefix="" suffix=".">
                    <list_item>
                        <paragraph>Run management command update_new_apple_ids_in_social_auth.</paragraph>
                    </list_item>
                </enumerated_list>
            </list_item>
            <list_item>
                <paragraph>Apple user migration is complete!</paragraph>
            </list_item>
        </enumerated_list>
        <target ids="id-token-from-apple-containing-user-information" names="id_token\ from\ apple\ containing\ user\ information" refuri="https://developer.apple.com/documentation/sign_in_with_apple/sign_in_with_apple_rest_api/authenticating_users_with_sign_in_with_apple"></target>
        <target ids="create-transfer-identifiers-for-all-apple-users" names="create\ transfer_identifiers\ for\ all\ apple\ users" refuri="https://developer.apple.com/documentation/sign_in_with_apple/transferring_your_apps_and_users_to_another_team"></target>
        <target ids="apple-continues-to-send-the-transfer-identifier" names="apple\ continues\ to\ send\ the\ transfer\ identifier" refuri="https://developer.apple.com/documentation/sign_in_with_apple/sign_in_with_apple_rest_api/authenticating_users_with_sign_in_with_apple"></target>
    </section>
</document>
