<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE document PUBLIC "+//IDN docutils.sourceforge.net//DTD Docutils Generic//EN//XML" "http://docutils.sourceforge.net/docs/ref/docutils.dtd">
<!-- Generated by Docutils 0.21.2 -->
<document source="/Users/sarinacanelake/static-clones/edx-platform/docs/references/docs/openedx/core/djangoapps/oauth_dispatch/docs/decisions/0013-mobile-migration-to-jwt.rst" translation_progress="{'total': 0, 'translated': 0}" xmlns:c="https://www.sphinx-doc.org/" xmlns:changeset="https://www.sphinx-doc.org/" xmlns:citation="https://www.sphinx-doc.org/" xmlns:cpp="https://www.sphinx-doc.org/" xmlns:http="https://www.sphinx-doc.org/" xmlns:index="https://www.sphinx-doc.org/" xmlns:js="https://www.sphinx-doc.org/" xmlns:math="https://www.sphinx-doc.org/" xmlns:py="https://www.sphinx-doc.org/" xmlns:rst="https://www.sphinx-doc.org/" xmlns:std="https://www.sphinx-doc.org/">
    <section ids="mobile-migration-to-jwt" names="13.\ mobile\ migration\ to\ jwt">
        <title>13. Mobile migration to JWT</title>
        <section ids="status" names="status">
            <title>Status</title>
            <paragraph>Accepted</paragraph>
        </section>
        <section ids="context" names="context">
            <title>Context</title>
            <paragraph>The Open edX mobile apps contain the final usage of the deprecated opaque Bearer access tokens, as documented in the <reference name="OAuth2 and Bearer Tokens section of OEP-42 on Authentication" refuri="https://github.com/openedx/open-edx-proposals/blob/6accfc7d5440c9c02f0c17e6ce65c7141af9551f/oeps/best-practices/oep-0042-bp-authentication.rst#oauth2-and-bearer-tokens">OAuth2 and Bearer Tokens section of OEP-42 on Authentication</reference>. Once the mobile apps are no longer using these opaque tokens, BearerAuthentication could be removed through the DEPR process.</paragraph>
            <paragraph>Additionally, the Open edX mobile apps plan to add payment features which require calling some ecommerce apis. However, the opaque Bearer access tokens can only be used for authentication and api calls in the lms. As detailed in OEP-42, the JWT access token is the recommended method of authenticating across services.</paragraph>
            <paragraph>Until this time, JWT access tokens were not supported for parts of the mobile authentication workflow. Once JWT authentication is enabled for mobile, most of the required apis for the new features already support JWT, and the ones that donâ€™t can be easily updated.</paragraph>
            <target ids="oauth2-and-bearer-tokens-section-of-oep-42-on-authentication" names="oauth2\ and\ bearer\ tokens\ section\ of\ oep-42\ on\ authentication" refuri="https://github.com/openedx/open-edx-proposals/blob/6accfc7d5440c9c02f0c17e6ce65c7141af9551f/oeps/best-practices/oep-0042-bp-authentication.rst#oauth2-and-bearer-tokens"></target>
        </section>
        <section ids="decisions" names="decisions">
            <title>Decisions</title>
            <paragraph>The mobile apps will migrate its authentication worklflow from using opaque Bearer access tokens to JWT access tokens for authentication, enabling the use of JWTs for cross-service authenticated api calls.</paragraph>
            <paragraph>The mobile app currently obtains an edX-issued access token in either of the following ways:</paragraph>
            <bullet_list bullet="*">
                <list_item>
                    <paragraph><literal>AccessToken View: username/email + password combo with grant_type=password</literal></paragraph>
                </list_item>
                <list_item>
                    <paragraph><literal>AccessTokenExchangeView: 3rd party (social-auth) OAuth 2.0 access token -&gt; 1st party (Open edX) OAuth 2.0 access token</literal></paragraph>
                </list_item>
            </bullet_list>
            <paragraph>Additionally, the mobile app can exchange an access token for a session cookie that can be used in a WebView:</paragraph>
            <bullet_list bullet="*">
                <list_item>
                    <paragraph><literal>LoginWithAccessTokenView: 1st party (Open edX) OAuth 2.0 access token -&gt; session cookie</literal></paragraph>
                </list_item>
            </bullet_list>
            <paragraph>The above three endpoints will be updated to also support JWTs. The mobile apps will then use <literal>JwtAuthentication</literal> on all the apis they call. Note: almost all the apis already support <literal>JwtAuthentication</literal>.</paragraph>
        </section>
        <section ids="consequences" names="consequences">
            <title>Consequences</title>
            <paragraph>For migrating the mobile authentication flow from opaque Bearer access tokens to JWTs, the following security risks were identified, and will be mitigated as detailed below:</paragraph>
            <bullet_list bullet="*">
                <list_item>
                    <paragraph>Reduce JWT access token expiration.</paragraph>
                    <bullet_list bullet="*">
                        <list_item>
                            <paragraph>One major difference between JWT and Bearer access tokens is that the JWT is non-revocable. Intentionally, there is no database lookup for a JWT and it is simply trusted if found to be valid.</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>One consequence of this is that a JWT should have a short lifetime in order to limit security risks if the token is hijacked.</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>JWT access token expiration time needs to be configurable separately from the opaque Bearer tokens to enable this change. (Completed as of the writing of this ADR.)</paragraph>
                        </list_item>
                    </bullet_list>
                </list_item>
                <list_item>
                    <paragraph>User Account Status:</paragraph>
                    <bullet_list bullet="*">
                        <list_item>
                            <paragraph>For 1st-party token exchange for session login using JWTs, it is especially important to ensure that the user account has not been disabled, since the JWT is non-revocable.</paragraph>
                        </list_item>
                    </bullet_list>
                </list_item>
                <list_item>
                    <paragraph>Password Grant Check</paragraph>
                    <bullet_list bullet="*">
                        <list_item>
                            <paragraph>For the currently proposed 1st-party token exchange for session login using JWTs, we would need an equivalent check to the existing <title_reference>_is_grant_password</title_reference> to not expand permissiveness of the endpoint.</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>For resolution, see the <reference name="ADR to add grant type in JWT payload" refuri="https://github.com/openedx/edx-platform/blob/master/openedx/core/djangoapps/oauth_dispatch/docs/decisions/0014-add-grant-type-in-jwt-payload.rst">ADR to add grant type in JWT payload</reference>.</paragraph>
                        </list_item>
                    </bullet_list>
                </list_item>
                <list_item>
                    <paragraph>Asymmetrically Signed JWT</paragraph>
                    <bullet_list bullet="*">
                        <list_item>
                            <paragraph>We need to check if the JWT was asymmetrically signed by the LMS. We want to ensure that a symmetrically signed JWT, created (signed) by another IDA, could not be compromised and used by an attacker to exchange for a session cookie, which would allow for full compromise of the user.</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>Implementation will involve adding a method to <literal>edx-drf-extensions</literal> like <literal>get_decoded_jwt_from_auth</literal>, but that will decode only asymmetric JWTs.</paragraph>
                        </list_item>
                        <list_item>
                            <paragraph>Auth token endpoints that return a JWT will now take a request parameter that will enable Mobile to request asymmetric JWTs. This will enable old symmetric JWTs to continue to work until they are fully deprecated/removed, but enable Mobile to request asymmetric JWTs for this new case where they are required.</paragraph>
                        </list_item>
                    </bullet_list>
                </list_item>
            </bullet_list>
            <target ids="adr-to-add-grant-type-in-jwt-payload" names="adr\ to\ add\ grant\ type\ in\ jwt\ payload" refuri="https://github.com/openedx/edx-platform/blob/master/openedx/core/djangoapps/oauth_dispatch/docs/decisions/0014-add-grant-type-in-jwt-payload.rst"></target>
        </section>
    </section>
</document>
